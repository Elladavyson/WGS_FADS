---
title: "FADS_prioritised_variants_lolliplots"
author: "Ella Davyson"
date: "2024-11-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyr)
library(dplyr)
library(trackViewer)
library(ggplot2)
library(ggpattern)
```

```{r}
########### PRIORITISED VARIANTS IN THE FADS CLUSTER ############
# Can run this locally (just variant information)
setwd("/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Intermediate_data_files")
FADS <- read.table("FADS_cluster_UKB_pVCF.tsv", sep = "\t", header = T)

# Read in the priority variant tables 

for (i in c(1:nrow(FADS))){
  gene <- FADS$hgnc_symbol[i]
  priority <- read.table(paste0("vep_res/AC_overzero/", gene, "_vepoutput_proc/", gene, "_priority_annot.tsv"), sep = "\t", header = T)
  print(paste0("Read in priority variants: ", gene, " (n=", nrow(priority), ")"))
  assign(paste0(gene, "_priority_var"), priority)
}

```

### Overlap in FADS1 and FADS2 priortised variants ? 

FADS1 and FADS2 overlap in positions as they are on opposing strands, FADS2 (Forward strand) encompasses the whole of FADS1. Does FADS2 have all the same variants as FADS1? 

Yes, they are all included
```{r}
table(FADS1_priority_var$chr_pos_ref_alt %in% FADS2_priority_var$chr_pos_ref_alt)
```

### Plotting the genes and their variants 

```{r}
mane_transcripts <- c("FADS1"="ENST00000350997",
                      "FADS2"="ENST00000278840",
                      "FADS3"="ENST00000278829",
                      "FEN1"="ENST00000305885",
                      "MYRF"="ENST00000278836",
                      "TMEM258"="ENST00000537328")

## Saving genomic region variant objects of the genes 
for (i in c(1:nrow(FADS))) {
  gene <- FADS$hgnc_symbol[i]
  transcript <- mane_transcripts[[gene]] %>% as.character()
Ensembl_file <- paste0("gene_ensembl_files/ExonsSpreadsheet-Homo_sapiens_Transcript_Exons_", transcript, "_", gene, ".csv")
  gene_start <- FADS$start_position[i]
  gene_end <- FADS$end_position[i]
  strand <- FADS$strand[i]
  ensembl <- read_csv(Ensembl_file) %>% 
as.data.frame() %>% 
select(-Sequence) %>% 
filter(!grepl('sequence', `Exon / Intron`)) %>%
mutate(ExonIntron = ifelse(grepl('Intron',`Exon / Intron`), "Intron", "Exon"))%>% 
mutate(color_for_lolliplot = ifelse(ExonIntron=="Intron","#26913D","#07C5F5"))
  if (strand == -1) {
features <- GRanges("chr11", IRanges(start=c(ensembl$End %>% rev()),
end=c(ensembl$Start %>% rev()),
names = c(ensembl$ExonIntron %>% rev()),
))
features$fill <- c(ensembl$color_for_lolliplot %>% rev())
} else if (strand == 1) {
features <- GRanges("chr11", IRanges(start=c(ensembl$Start),
end=c(ensembl$End),
names = c(ensembl$ExonIntron),
))
features$fill <-  c(ensembl$color_for_lolliplot)
} else {
    stop("Provide strand info for plotting")
}
  # Read in prioritised variants 
    variant <- read.table(paste0("vep_res/AC_overzero/", gene, "_vepoutput_proc/", gene, "_priority_annot.tsv"), sep = "\t", header = T)
  # Read in variant zygosity
    variant_zygosity <- fread(paste0("variant_althet_counts/", gene, "_variant_zygosity.tsv"), sep = "\t")
    # Merge together 
variant <- merge(variant, variant_zygosity %>% select(-c(CHR, POS, REF, ALT)), by = "chr_pos_ref_alt")
variant <- variant %>% mutate(color_for_lolliplot_impact = case_when(IMPACT == "HIGH" ~ "red", IMPACT == "MODERATE" ~ "orange", IMPACT == "LOW" ~ "#90EE90", IMPACT == "MODIFIER" ~ "lightpink"))
SNP <- as.numeric(variant$POS)
sample.gr <- GRanges(unique(variant$CHR), 
IRanges(SNP, width=1, names=c(1:length(SNP))), 
strand=ifelse(strand == 1, "+", "-"))
sample.gr$color <- variant$color_for_lolliplot_impact
sample.gr$label.parameter.label <- ""
sample.gr$score <- variant$althet_carriers
sample.gr$node.label <- as.character(sample.gr$score)
legend <- list(labels=c("HIGH" , "MODERATE", "LOW", "MODIFIER"), 
               col = c("red","orange", "#90EE90", "lightpink"), 
               fill = c("red","orange", "#90EE90", "lightpink"))
if(max(variant$althet_carriers) > 1000) {
text_gpar <- gpar(fontsize=7, col="black")
sample.gr$node.label.cex <- 0.6
} else if (max(variant$althet_carriers > 100)) {
  text_gpar <- gpar(fontsize=8, col="black")
sample.gr$node.label.cex <- 0.75
} else {
  text_gpar <- gpar(col="black")
sample.gr$node.label.cex <- 1
}
print(paste0("Saving the lolliplot to ", gene, "_lolliplot_variants_pri.png"))
png(paste0("/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Plots/", gene, "_lolliplot_variants_all.png"),
    width = 4000, height = 1200, res = 300, type = "cairo")
lolliplot(sample.gr, features, legend = legend, ylab = "Alt-heterozygous carriers in UKB Sample (N)", yaxis.gp = text_gpar)
grid.text(paste0("Prioritised variants in ", gene), x=.5, y=.8, just="top", 
          gp=gpar(cex=1.5, fontface="bold"))
dev.off()
variant$GENE <- gene
assign(paste0(gene, "_pri_vars_genoinfo"), variant)
}

```
## Generating the annotations file for REGENIE masks

The annotation file is in the following format

chrposrefalt    GENE    annotation (most deleterious)
Annotations in the order of deleteriousness: 

LoFTEE- High Confidence Loss of Function
VEP IMPACT - HIGH
HIGH REVEL score 
CADD score 
VEP IMPACT - MODERATE

Mask 1 - LoFTEE
Mask 2 - LoFTEE, VEP IMPACT HIGH
Mask 3 - LoFTEE, VEP IMPACT HIGH, HIGH REVEL SCORE (> 0.5)
Mask 4 - LoFTEE, VEP IMPACT HIGH, HIGH REVEL SCORE (> 0.5), HIGH CADD SCORE (> 20)
Mask 5 - LoFTEE, VEP IMPACT HIGH, HIGH REVEL SCORE (> 0.5), HIGH CADD SCORE (> 20), MODERATE VEP IMPACT 


```{r}
gene_symbols <- c(
  "ENSG00000149485"="FADS1",
  "ENSG00000134824"="FADS2",
  "ENSG00000221968"="FADS3",
  "ENSG00000168496"="FEN1",
  "ENSG00000124920"="MYRF",
  "ENSG00000134825"="TMEM258"
)

assign_masks <- function(df, gene) {
  df <- df %>%
    mutate(most_deleterious = 
                        case_when(LoF == "HC" | LoF == "OS" ~ "LoF",
                                  (LoF != "HC" | LoF != "OS") & IMPACT == "HIGH" ~ "H_IMPACT",
                                  (LoF != "HC" | LoF != "OS") & IMPACT != "HIGH" & REVEL >= 0.5 ~ "REVEL",
                                  (LoF != "HC" | LoF != "OS") & IMPACT != "HIGH" & (REVEL < 0.5 | is.na(REVEL)) & CADD_PHRED >= 20 ~ "CADD",
                                  (LoF != "HC" | LoF != "OS") & IMPACT != "HIGH" & (CADD_PHRED < 20 | is.na(CADD_PHRED)) & (REVEL < 0.5 | is.na(REVEL)) & IMPACT == "MODERATE" ~ "MOD_IMPACT")) %>% 
    mutate(mask1 = ifelse(most_deleterious == "LoF", 1, 0),
           mask2 = ifelse(most_deleterious == "LoF" | most_deleterious == "H_IMPACT", 1, 0),
           mask3 = ifelse(most_deleterious == "LoF" | most_deleterious == "H_IMPACT" | most_deleterious == "REVEL", 1, 0),
           mask4 = ifelse(most_deleterious == "LoF" | most_deleterious == "H_IMPACT" | most_deleterious == "REVEL" | most_deleterious == "CADD", 1, 0),
           mask5 = ifelse(most_deleterious == "LoF" | most_deleterious == "H_IMPACT" | most_deleterious == "CADD" | most_deleterious == "REVEL" | most_deleterious == "MOD_IMPACT", 1, 0))
  return(df)
}

priority_var_list <- list(FADS1_priority_var, FADS2_priority_var, FADS3_priority_var, FEN1_priority_var, MYRF_priority_var, TMEM258_priority_var)
priority_var_list <- lapply(priority_var_list, assign_masks)
priority_var_all <- do.call(rbind, priority_var_list)
mask_long <- priority_var_all %>% select(c(Gene, starts_with("mask"))) %>% 
  pivot_longer(cols = starts_with("mask"), names_to = "Mask", values_to = "Value") %>% 
  mutate(GENE = gene_symbols[Gene] %>% as.character()) %>% 
  mutate(mask_label = case_when(
    Mask == "mask1" ~ "LoF",
    Mask == "mask2" ~ "+HIGH IMPACT",
    Mask == "mask3" ~ "+REVEL > 0.5",
    Mask == "mask4" ~ "+CADD > 20",
    Mask == "mask5" ~ "+MODERATE IMPACT"
  ))

mask_long <- mask_long %>% mutate(mask_label=factor(mask_label, levels = c("LoF", "+HIGH IMPACT", "+REVEL > 0.5", "+CADD > 20", "+MODERATE IMPACT")))
mask_numbers <- ggplot(mask_long %>% filter(Value == 1), aes(x = mask_label, fill = mask_label)) + 
  geom_bar(stat="count") + 
  facet_wrap(~GENE) + 
  theme_minimal() + 
  scale_fill_brewer(palette ="Set1") + scale_color_brewer(palette="Set1")+ 
  labs(x = "Mask", y = "Count", fill = "Mask Criteria") + 
  theme(
    axis.text.x = element_blank(),  # Remove x-axis tick labels
    axis.ticks.x = element_blank()
  ) + geom_text(stat="count", aes(label = after_stat(count), color = mask_label), vjust = -0.5, size = 3, show.legend = FALSE) +
guides(color= guide_legend(label = FALSE)) + facet_wrap(~GENE)

ggsave (filename= "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Plots/FADS_variant_masks_counts.png", mask_numbers, width = 10, height = 6, device = "png", dpi= 300)
mask_numbers
```

You can also divide masks by the Allele Frequency. There is always a singletons only mask, but can set other thresholds. For each mask, we can subdivide to all (< 0.01), those (< 0.0001) and singletons. 

```{r}
priority_var_all <- 
  priority_var_all %>% mutate(
    mask1_0.01 = mask1,
    mask1_0.001 = ifelse(mask1 == 1 & AF < 0.001, 1, 0),
    mask1_0.0001 = ifelse(mask1 == 1 & AF < 0.0001, 1, 0),
    mask1_singleton = ifelse(mask1 == 1 & AC == 1, 1,0),
    mask2_0.01 = mask2,
        mask2_0.001 = ifelse(mask2 == 1 & AF < 0.001, 1, 0),
    mask2_0.0001 = ifelse(mask2 == 1 & AF < 0.0001, 1, 0),
    mask2_singleton = ifelse(mask2 == 1 & AC == 1, 1,0),
     mask3_0.01 = mask3,
        mask3_0.001 = ifelse(mask3 == 1 & AF < 0.001, 1, 0),
    mask3_0.0001 = ifelse(mask3 == 1 & AF < 0.0001, 1, 0),
    mask3_singleton = ifelse(mask3 == 1 & AC == 1, 1,0),
     mask4_0.01 = mask4,
        mask4_0.001 = ifelse(mask4 == 1 & AF < 0.001, 1, 0),
    mask4_0.0001 = ifelse(mask4 == 1 & AF < 0.0001, 1, 0),
    mask4_singleton = ifelse(mask4 == 1 & AC == 1, 1,0),
     mask5_0.01 = mask5,
        mask5_0.001 = ifelse(mask5 == 1 & AF < 0.001, 1, 0),
    mask5_0.0001 = ifelse(mask5 == 1 & AF < 0.0001, 1, 0),
    mask5_singleton = ifelse(mask5 == 1 & AC == 1, 1,0)
  ) %>% 
  select(-c(mask1, mask2, mask3, mask4, mask5))

mask_af_long <- 
  priority_var_all %>% 
  select(c(Gene, starts_with("mask"))) %>%
  pivot_longer(
    cols = starts_with("mask"),
    names_to = c("Mask", "AF_Threshold"),
    names_sep = "_",
    values_to="Value"
  ) %>% 
  mutate(GENE = gene_symbols[Gene] %>% as.character()) %>% 
  mutate(mask_label = case_when(
    Mask == "mask1" ~ "LoF",
    Mask == "mask2" ~ "+HIGH IMPACT",
    Mask == "mask3" ~ "+REVEL > 0.5",
    Mask == "mask4" ~ "+CADD > 20",
    Mask == "mask5" ~ "+MODERATE IMPACT"
  ))

mask_af_long$AF_Threshold <- factor(mask_af_long$AF_Threshold, levels = c("singleton", "0.0001", "0.001", "0.01"))
mask_af_long <- mask_af_long %>% mutate(mask_label=factor(mask_label, levels = c("LoF", "+HIGH IMPACT", "+REVEL > 0.5", "+CADD > 20", "+MODERATE IMPACT")))

mask_af_plt <- ggplot(mask_af_long %>% filter(Value ==1), aes(x = AF_Threshold, fill = mask_label)) +
  geom_bar(stat = "count", position = position_dodge(width=0.8)) +
 geom_text(stat="count", aes(label = after_stat(count), color = mask_label), vjust = -0.5, size = 3, show.legend = FALSE, position = position_dodge(width = 0.8)) +
guides(color= guide_legend(label = FALSE)) +
  facet_wrap(~GENE) +  # Facet by GENE
  scale_fill_brewer(palette = "Set1") +
  scale_color_brewer(palette="Set1")+
  labs(x = "AF Threshold", y = "Count", title = "Variant Count by AF Threshold and Mask", fill = "Mask Criteria") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

ggsave(filename= "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Plots/FADS_variant_masks_af_counts.png", mask_af_plt, width = 10, height = 6, device = "png", dpi= 300)
mask_af_plt

```

The biggest change in number of variants is between singleton variants and 0.01, so just include two aaf bins in REGENIE, using --aaf-bins 0.01 
(singletons are always included as a default in addition to this flag)
## REGENIE Input

Saving an annotation file for REGENIE Input
chr:pos:ref:alt   Gene    Annotation
```{r}
# From each gene priority variants
anno_file <- priority_var_all %>% 
  mutate(chrposrefalt = gsub("_", ":", chr_pos_ref_alt)) %>%  
  mutate(chrposrefalt=gsub("chr", "", chrposrefalt)) %>%
  select(c(chrposrefalt, Gene, most_deleterious)) %>% 
  mutate(Gene = gene_symbols[Gene])
  write.table(anno_file, "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Intermediate_data_files/REGENIE input/annotations_FADS.tsv", sep = "\t", row.names =F , quote = F, col.names = F)
  
# The REVEL > 0.5 annotations are captured in all the variants by the other annotation criteria
# Therefore do not need a whole separate mask for REVEL additions (so 4 masks overall)
  
  mask_file <- c("Mask1 LoF", "Mask2 LoF,H_IMPACT", "Mask3 LoF,H_IMPACT,REVEL", "Mask4 LoF,H_IMPACT,REVEL,CADD", "Mask5 LoF,H_IMPACT,REVEL,CADD,MOD_IMPACT")
readr::write_lines(mask_file, "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Intermediate_data_files/REGENIE input/masks_FADS.txt")
write.table(mask_file, "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Intermediate_data_files/REGENIE input/masks_FADS.txt", row.names=F, col.names = F, quote = F)

# Set list file 

setlist <- priority_var_all %>% 
  mutate(chrposrefalt=gsub("_", ":", chr_pos_ref_alt)) %>% 
  mutate(chrposrefalt=gsub("chr", "", chrposrefalt)) %>%
  group_by(SYMBOL) %>% summarise(variants = paste0(chrposrefalt, collapse = ",")) %>% mutate(CHR = 11)

setlist <- merge(setlist, FADS %>% select(hgnc_symbol, start_position), by.x = "SYMBOL", by.y = "hgnc_symbol")

setlist <- setlist %>% select(SYMBOL,CHR, start_position, variants)

write.table(setlist, "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Intermediate_data_files/REGENIE input/setlist_FADS.tsv", sep = "\t", row.names =F , col.names = F, quote = F)

# AAF file 

aaf_file <- priority_var_all %>% 
  mutate(chrposrefalt=gsub("_", ":", chr_pos_ref_alt)) %>%   mutate(chrposrefalt=gsub("chr", "", chrposrefalt)) %>% select(chrposrefalt, AF, AC) %>% mutate(singleton=ifelse(AC==1,1,0)) %>% 
  select(-AC)

# Use the --set-singletons flag as this AAF file has provided information on whether it's a singleton

write.table(aaf_file, "/Users/ellad/UniversityEdinburgh/PhD/Year_3/WGS_proj/Intermediate_data_files/REGENIE input/aaf_FADS.tsv", sep = "\t", col.names = F, row.names = F, quote = F)
```

